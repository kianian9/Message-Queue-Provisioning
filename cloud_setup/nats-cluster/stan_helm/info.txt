kubectl apply -f stan/gce_standard_storageclass.yaml

kubectl create namespace nats
helm repo add nats https://nats-io.github.io/k8s/helm/charts/
helm install my-nats nats/nats --namespace nats --set cluster.enabled=true, cluster.noAdvertise=true, leafnodes.enabled=true, leafnodes.noAdvertise=true, natsbox.enabled=true
helm install -f kian_test/nats/values.yaml -n nats my-nats ./kian_test/nats/


helm install my-stan nats/stan --namespace nats --set stan.nats.url=nats://my-nats:4222, stan.replicas=3, store.cluster.enabled=true, store.volume.storageClass=stan-sc, stan.clusterID=stan, exporter.enabled=true, exporter.serviceMonitor.enabled=true
helm install -f kian_test/stan/values.yaml -n nats my-stan ./kian_test/stan/


kubectl create namespace prometheus

helm install prometheus stable/prometheus-operator --namespace prometheus --set prometheusOperator.enabled=false



helm uninstall -n nats my-stan ./kian_test/stan/


kubectl apply -f kian_test/prometheus-operator-deployment.yaml -n nats



NAME: my-nats
LAST DEPLOYED: Tue Feb 23 11:49:00 2021
NAMESPACE: nats
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
You can find more information about running NATS on Kubernetes
in the NATS documentation website:

  https://docs.nats.io/nats-on-kubernetes/nats-kubernetes

NATS Box has been deployed into your cluster, you can
now use the NATS tools within the container as follows:

  kubectl exec -n nats -it deployment/my-nats-box -- /bin/sh -l

  nats-box:~# nats-sub test &
  nats-box:~# nats-pub test hi
  nats-box:~# nc my-nats 4222

http://prometheus-operated:9090/



printf "\nInitializing NATS Operator (1)\n"
    kubectl apply -f kian_test/nats-operator1.yaml -n nats

    # TODO Wait for all pods to be done: kubectl get pods -n nats where nats-operator**** needs to be Running
    printf "\nInitializing NATS Operator (2)\n"
    kubectl apply -f kian_test/nats-operator2.yaml -n nats

    printf "\nWaiting for NATS Operator to become ready...\n"
    x=0
    READY="Running"
    while [ $x -le 0 ]
    do
        IS_READY=$(kubectl get pods -n nats | grep nats-operator 2>/dev/null)
        if [[ "$IS_READY" =~ "$READY" ]] && [[ "$IS_READY" =~ "1/1" ]]; then
            x=$(( $x + 1 ))
        else
            sleep 2
        fi
    done

    # TODO Wait for all pods to be done: kubectl get pods -n nats where prometheus-operator*** needs to be Running
    printf "\nInitializing Prometheus Operator\n"
    kubectl apply -f kian_test/prometheus-operator.yaml -n nats

    printf "\nWaiting for Prometheus Operator to become ready...\n"
    x=0
    READY="Running"
    while [ $x -le 0 ]
    do
        IS_READY=$(kubectl get pods -n nats | grep prometheus-operator 2>/dev/null)
        if [[ "$IS_READY" =~ "$READY" ]] && [[ "$IS_READY" =~ "1/1" ]]; then
            x=$(( $x + 1 ))
        else
            sleep 2
        fi
    done

    printf "\nInitializing NATS Cluster\n"
    kubectl apply -f kian_test/nats-cluster.yaml -n nats

    printf "\nInitializing Prometheus Rules\n"
    kubectl apply -f kian_test/prometheus-rbac.yaml -n nats

    printf "\nInitializing Prometheous Instance For NATS\n"
    kubectl apply -f kian_test/prometheus-instance.yaml -n nats

    printf "\nSetup Prometheous ServiceMonitor For NATS\n"
    kubectl apply -f kian_test/service-monitor.yaml -n nats
